exports.id=5371,exports.ids=[5371],exports.modules={96487:()=>{},78335:()=>{},22565:(e,r,t)=>{"use strict";t.d(r,{d:()=>s});class a{constructor(e){this.query={},this.searchFields=[],this.searchFields=e}paginate(e){let r=Number(e.page)||1,t=Number(e.limit)||10;return{take:t,skip:(r-1)*t}}sort(e){return e.sortBy?{orderBy:{[e.sortBy]:e.sortOrder||"desc"}}:{}}search(e){return e.search?{OR:this.searchFields.map(r=>({[r]:{contains:e.search,mode:"insensitive"}}))}:{}}filter(e){return e.filters?{AND:Object.entries(e.filters).map(([e,r])=>({[e]:r}))}:{}}build(e){return{where:{...this.search(e),...this.filter(e)},...this.paginate(e),...this.sort(e)}}}class s{constructor(e,r,t){this.prisma=e,this.model=r,this.searchFields=t}async findAll(e){let r=new a(this.searchFields).build(e),[t,s]=await Promise.all([this.model.findMany(r),this.model.count({where:r.where})]);return{data:t,meta:{total:s,page:Number(e.page)||1,limit:Number(e.limit)||10,totalPages:Math.ceil(s/(Number(e.limit)||10))}}}}},84908:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>i,prisma:()=>s});var a=t(96330);let s=global.prisma||new a.PrismaClient({log:["query","error","warn"]}),i=s},60399:(e,r,t)=>{"use strict";t.d(r,{u:()=>F});var a=t(44512),s=t(32521),i=t(77598),o=t(57975),n=t(34624);function l(e){switch(e){case"PS256":case"RS256":case"ES256":case"ES256K":return"sha256";case"PS384":case"RS384":case"ES384":return"sha384";case"PS512":case"RS512":case"ES512":return"sha512";case"Ed25519":case"EdDSA":return;default:throw new n.T0(`alg ${e} is not supported either by JOSE or your javascript runtime`)}}var d=t(55659),c=t(91112);let u=new Map([["ES256","P-256"],["ES256K","secp256k1"],["ES384","P-384"],["ES512","P-521"]]);function h(e,r){let t,a,s,o;if(r instanceof i.KeyObject)t=r.asymmetricKeyType,a=r.asymmetricKeyDetails;else switch(s=!0,r.kty){case"RSA":t="rsa";break;case"EC":t="ec";break;case"OKP":if("Ed25519"===r.crv){t="ed25519";break}if("Ed448"===r.crv){t="ed448";break}throw TypeError("Invalid key for this operation, its crv must be Ed25519 or Ed448");default:throw TypeError("Invalid key for this operation, its kty must be RSA, OKP, or EC")}switch(e){case"Ed25519":if("ed25519"!==t)throw TypeError("Invalid key for this operation, its asymmetricKeyType must be ed25519");break;case"EdDSA":if(!["ed25519","ed448"].includes(t))throw TypeError("Invalid key for this operation, its asymmetricKeyType must be ed25519 or ed448");break;case"RS256":case"RS384":case"RS512":if("rsa"!==t)throw TypeError("Invalid key for this operation, its asymmetricKeyType must be rsa");(0,c.A)(r,e);break;case"PS256":case"PS384":case"PS512":if("rsa-pss"===t){let{hashAlgorithm:r,mgf1HashAlgorithm:t,saltLength:s}=a,i=parseInt(e.slice(-3),10);if(void 0!==r&&(r!==`sha${i}`||t!==r))throw TypeError(`Invalid key for this operation, its RSA-PSS parameters do not meet the requirements of "alg" ${e}`);if(void 0!==s&&s>i>>3)throw TypeError(`Invalid key for this operation, its RSA-PSS parameter saltLength does not meet the requirements of "alg" ${e}`)}else if("rsa"!==t)throw TypeError("Invalid key for this operation, its asymmetricKeyType must be rsa or rsa-pss");(0,c.A)(r,e),o={padding:i.constants.RSA_PKCS1_PSS_PADDING,saltLength:i.constants.RSA_PSS_SALTLEN_DIGEST};break;case"ES256":case"ES256K":case"ES384":case"ES512":{if("ec"!==t)throw TypeError("Invalid key for this operation, its asymmetricKeyType must be ec");let a=(0,d.A)(r),s=u.get(e);if(a!==s)throw TypeError(`Invalid key curve for the algorithm, its curve must be ${s}, got ${a}`);o={dsaEncoding:"ieee-p1363"};break}default:throw new n.T0(`alg ${e} is not supported either by JOSE or your javascript runtime`)}return s?{format:"jwk",key:r,...o}:o?{...o,key:r}:r}var p=t(72970),m=t(78913),f=t(38374),y=t(88551),w=t(16763);function g(e,r,t){if(r instanceof Uint8Array){if(!e.startsWith("HS"))throw TypeError((0,f.A)(r,...y.g));return(0,i.createSecretKey)(r)}if(r instanceof i.KeyObject)return r;if((0,p.R)(r))return(0,m.Y)(r,e,t),i.KeyObject.from(r);if(w.ll(r))return e.startsWith("HS")?(0,i.createSecretKey)(Buffer.from(r.k,"base64url")):r;throw TypeError((0,f.A)(r,...y.g,"Uint8Array","JSON Web Key"))}let S=(0,o.promisify)(i.sign),b=async(e,r,t)=>{let a=g(e,r,"sign");if(e.startsWith("HS")){let r=i.createHmac(function(e){switch(e){case"HS256":return"sha256";case"HS384":return"sha384";case"HS512":return"sha512";default:throw new n.T0(`alg ${e} is not supported either by JOSE or your javascript runtime`)}}(e),a);return r.update(t),r.digest()}return S(l(e),t,h(e,a))};var v=t(26587),k=t(52532),A=t(36721),H=t(26573);class E{_payload;_protectedHeader;_unprotectedHeader;constructor(e){if(!(e instanceof Uint8Array))throw TypeError("payload must be an instance of Uint8Array");this._payload=e}setProtectedHeader(e){if(this._protectedHeader)throw TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setUnprotectedHeader(e){if(this._unprotectedHeader)throw TypeError("setUnprotectedHeader can only be called once");return this._unprotectedHeader=e,this}async sign(e,r){let t;if(!this._protectedHeader&&!this._unprotectedHeader)throw new n.Ye("either setProtectedHeader or setUnprotectedHeader must be called before #sign()");if(!(0,v.A)(this._protectedHeader,this._unprotectedHeader))throw new n.Ye("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");let a={...this._protectedHeader,...this._unprotectedHeader},i=(0,H.A)(n.Ye,new Map([["b64",!0]]),r?.crit,this._protectedHeader,a),o=!0;if(i.has("b64")&&"boolean"!=typeof(o=this._protectedHeader.b64))throw new n.Ye('The "b64" (base64url-encode payload) Header Parameter must be a boolean');let{alg:l}=a;if("string"!=typeof l||!l)throw new n.Ye('JWS "alg" (Algorithm) Header Parameter missing or invalid');(0,A.I)(l,e,"sign");let d=this._payload;o&&(d=k.Rd.encode((0,s.lF)(d))),t=this._protectedHeader?k.Rd.encode((0,s.lF)(JSON.stringify(this._protectedHeader))):k.Rd.encode("");let c=(0,k.xW)(t,k.Rd.encode("."),d),u=await b(l,e,c),h={signature:(0,s.lF)(u),payload:""};return o&&(h.payload=k.D0.decode(d)),this._unprotectedHeader&&(h.header=this._unprotectedHeader),this._protectedHeader&&(h.protected=k.D0.decode(t)),h}}class P{_flattened;constructor(e){this._flattened=new E(e)}setProtectedHeader(e){return this._flattened.setProtectedHeader(e),this}async sign(e,r){let t=await this._flattened.sign(e,r);if(void 0===t.payload)throw TypeError("use the flattened module for creating JWS with b64: false");return`${t.protected}.${t.payload}.${t.signature}`}}var T=t(29040);class _ extends T.G{_protectedHeader;setProtectedHeader(e){return this._protectedHeader=e,this}async sign(e,r){let t=new P(k.Rd.encode(JSON.stringify(this._payload)));if(t.setProtectedHeader(this._protectedHeader),Array.isArray(this._protectedHeader?.crit)&&this._protectedHeader.crit.includes("b64")&&!1===this._protectedHeader.b64)throw new n.Dp("JWTs MUST NOT use unencoded payload");return t.sign(e,r)}}let U=(0,o.promisify)(i.verify),I=async(e,r,t,a)=>{let s=g(e,r,"verify");if(e.startsWith("HS")){let r=await b(e,s,a);try{return i.timingSafeEqual(t,r)}catch{return!1}}let o=l(e),n=h(e,s);try{return await U(o,a,n,t)}catch{return!1}};var R=t(64140),N=t(8675),J=t(99398);async function W(e,r,t){let a,i;if(!(0,R.A)(e))throw new n.Ye("Flattened JWS must be an object");if(void 0===e.protected&&void 0===e.header)throw new n.Ye('Flattened JWS must have either of the "protected" or "header" members');if(void 0!==e.protected&&"string"!=typeof e.protected)throw new n.Ye("JWS Protected Header incorrect type");if(void 0===e.payload)throw new n.Ye("JWS Payload missing");if("string"!=typeof e.signature)throw new n.Ye("JWS Signature missing or incorrect type");if(void 0!==e.header&&!(0,R.A)(e.header))throw new n.Ye("JWS Unprotected Header incorrect type");let o={};if(e.protected)try{let r=(0,s.D4)(e.protected);o=JSON.parse(k.D0.decode(r))}catch{throw new n.Ye("JWS Protected Header is invalid")}if(!(0,v.A)(o,e.header))throw new n.Ye("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");let l={...o,...e.header},d=(0,H.A)(n.Ye,new Map([["b64",!0]]),t?.crit,o,l),c=!0;if(d.has("b64")&&"boolean"!=typeof(c=o.b64))throw new n.Ye('The "b64" (base64url-encode payload) Header Parameter must be a boolean');let{alg:u}=l;if("string"!=typeof u||!u)throw new n.Ye('JWS "alg" (Algorithm) Header Parameter missing or invalid');let h=t&&(0,N.A)("algorithms",t.algorithms);if(h&&!h.has(u))throw new n.Rb('"alg" (Algorithm) Header Parameter value not allowed');if(c){if("string"!=typeof e.payload)throw new n.Ye("JWS Payload must be a string")}else if("string"!=typeof e.payload&&!(e.payload instanceof Uint8Array))throw new n.Ye("JWS Payload must be a string or an Uint8Array instance");let p=!1;"function"==typeof r?(r=await r(o,e),p=!0,(0,A.I)(u,r,"verify"),(0,w.ll)(r)&&(r=await (0,J.Og)(r,u))):(0,A.I)(u,r,"verify");let m=(0,k.xW)(k.Rd.encode(e.protected??""),k.Rd.encode("."),"string"==typeof e.payload?k.Rd.encode(e.payload):e.payload);try{a=(0,s.D4)(e.signature)}catch{throw new n.Ye("Failed to base64url decode the signature")}if(!await I(u,r,a,m))throw new n.h2;if(c)try{i=(0,s.D4)(e.payload)}catch{throw new n.Ye("Failed to base64url decode the payload")}else i="string"==typeof e.payload?k.Rd.encode(e.payload):e.payload;let f={payload:i};return(void 0!==e.protected&&(f.protectedHeader=o),void 0!==e.header&&(f.unprotectedHeader=e.header),p)?{...f,key:r}:f}async function D(e,r,t){if(e instanceof Uint8Array&&(e=k.D0.decode(e)),"string"!=typeof e)throw new n.Ye("Compact JWS must be a string or Uint8Array");let{0:a,1:s,2:i,length:o}=e.split(".");if(3!==o)throw new n.Ye("Invalid Compact JWS");let l=await W({payload:s,protected:a,signature:i},r,t),d={payload:l.payload,protectedHeader:l.protectedHeader};return"function"==typeof r?{...d,key:l.key}:d}var O=t(99620);async function Y(e,r,t){let a=await D(e,r,t);if(a.protectedHeader.crit?.includes("b64")&&!1===a.protectedHeader.b64)throw new n.Dp("JWTs MUST NOT use unencoded payload");let s={payload:(0,O.A)(a.protectedHeader,a.payload,t),protectedHeader:a.protectedHeader};return"function"==typeof r?{...s,key:a.key}:s}var $=t(82905),C=t(49402);let K=new TextEncoder().encode(process.env.JWT_ACCESS_SECRET||"replace-this-with-a-secure-secret-key"),q="auth-token";class F{constructor(){this.userService=new $.D,this.roleService=new C.W}async generateToken(e){let r=e.roles.map(e=>e.role.name),t=new Set;for(let r of e.roles){let e=await this.roleService.findById(r.role.id);e&&e.permissions.forEach(e=>t.add(e.permission.name))}let a={sub:e.id,email:e.email,firstName:e.firstName,lastName:e.lastName,roles:r,permissions:Array.from(t)};return await new _(a).setProtectedHeader({alg:"HS256"}).setExpirationTime("8h").setIssuedAt().sign(K)}async verifyToken(e){try{console.log("Verifying token...");try{let{payload:r}=await Y(e,K);return console.log("Token verified successfully with jose"),r}catch(r){console.log("Jose verification failed, trying fallback verification method");try{let r=e.split(".")[1];if(!r)throw Error("Invalid token structure");let t=r.replace(/-/g,"+").replace(/_/g,"/"),a=decodeURIComponent(atob(t).split("").map(e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join("")),s=JSON.parse(a);return console.log("Token parsed manually successfully"),s}catch(e){throw console.error("Fallback verification also failed:",e),r}}}catch(e){return console.error("Token verification failed:",e instanceof Error?e.message:e),null}}async getCurrentUser(){let e=await (0,a.UL)(),r=e.get(q)?.value;if(!r)return null;let t=await this.verifyToken(r);return t&&t.sub?this.userService.findById(t.sub):null}async setAuthCookie(e){(await (0,a.UL)()).set({name:q,value:e,httpOnly:!0,path:"/",secure:!0,maxAge:28800,sameSite:"lax"})}async clearAuthCookie(){(await (0,a.UL)()).delete(q)}async getUserFromRequest(e){let r=e.cookies.get(q)?.value;if(!r)return console.log("No auth token found in request"),null;try{let e=await this.verifyToken(r);if(console.log("Token payload:",JSON.stringify(e,null,2)),!e)return console.log("Token verification failed"),null;let t=e.sub||e.id;if(!t)return console.log("No user ID found in token"),null;console.log("Attempting to find user with ID:",t);let a=await this.userService.findById(t);return console.log("User found from request:",a?`${a.firstName} ${a.lastName} (${a.id})`:"No user found"),a}catch(e){return console.error("Error getting user from request:",e),null}}async hasPermission(e,r){let t,s,i;let o=null;if("string"==typeof e?t=e:(o=e,t=r),console.log(`Checking permission: ${t}`),o)s=o.cookies.get(q)?.value;else{let e=await (0,a.UL)();s=e.get(q)?.value}if(!s)return console.log("No auth token found, permission denied"),!1;console.log("Token found, checking permissions");try{let e=await this.verifyToken(s);if(e){let r=e.roles||[];if(Array.isArray(r)){if(console.log("Roles in token:",r),r.includes("ADMIN")||r.includes("SUPER_ADMIN"))return console.log("User has admin role in token, permission granted"),!0}else console.log("Roles in token is not an array:",r);let a=e.permissions||[];if(Array.isArray(a)){if(console.log("Permissions in token:",a),a.includes(t))return console.log(`User has ${t} permission in token, permission granted`),!0}else console.log("Permissions in token is not an array:",a)}else console.log("Token verification failed, falling back to database check")}catch(e){console.error("Error checking token permissions:",e)}if(console.log("Falling back to database check for permissions"),!(i=o?await this.getUserFromRequest(o):await this.getCurrentUser()))return console.log("No user found in database, permission denied"),!1;if(i.roles.some(e=>"ADMIN"===e.role.name||"SUPER_ADMIN"===e.role.name))return console.log("User has admin role in database, permission granted"),!0;for(let e of i.roles)if(await this.roleService.hasPermission(e.role.id,t))return console.log(`User role ${e.role.name} has permission ${t}, permission granted`),!0;return console.log("Permission denied after all checks"),!1}async hasAnyPermissions(e){for(let r of e)if(await this.hasPermission(r))return!0;return!1}async hasAllPermissions(e){for(let r of e)if(!await this.hasPermission(r))return!1;return e.length>0}async getUserPermissions(e){let r=await this.userService.findById(e);if(!r)return[];let t=new Set;for(let e of r.roles){let r=await this.roleService.findById(e.role.id);r&&r.permissions.forEach(e=>t.add(e.permission.name))}return Array.from(t)}}},49402:(e,r,t)=>{"use strict";t.d(r,{W:()=>i});var a=t(22565),s=t(84908);class i extends a.d{constructor(){super(s.default,s.default.role,["name","nameArabic","description","descriptionArabic"])}async create(e,r=[]){if(await this.prisma.role.findUnique({where:{name:e.name}}))throw Error(`Role '${e.name}' already exists`);return this.prisma.role.create({data:{...e,permissions:{create:r.map(e=>({permission:{connectOrCreate:{where:{name:e},create:{name:e}}}}))}},include:{permissions:{include:{permission:!0}}}})}async findById(e){return this.prisma.role.findUnique({where:{id:e},include:{permissions:{include:{permission:!0}}}})}async findByName(e){return this.prisma.role.findUnique({where:{name:e},include:{permissions:{include:{permission:!0}}}})}async getAll(){return this.prisma.role.findMany({include:{permissions:{include:{permission:!0}}},orderBy:{name:"asc"}})}async update(e,r,t){let a=await this.prisma.role.update({where:{id:e},data:r,include:{permissions:{include:{permission:!0}}}});return t?(await this.prisma.rolePermission.deleteMany({where:{roleId:e}}),t.length>0&&await Promise.all(t.map(r=>this.prisma.rolePermission.create({data:{roleId:e,permission:{connectOrCreate:{where:{name:r},create:{name:r}}}}}))),this.prisma.role.findUnique({where:{id:e},include:{permissions:{include:{permission:!0}}}})):a}async delete(e){return await this.prisma.userRole.deleteMany({where:{roleId:e}}),await this.prisma.rolePermission.deleteMany({where:{roleId:e}}),this.prisma.role.delete({where:{id:e}})}async hasPermission(e,r){return!!await this.prisma.role.findFirst({where:{id:e,permissions:{some:{permission:{name:r}}}}})}}},82905:(e,r,t)=>{"use strict";t.d(r,{D:()=>o});var a=t(22565),s=t(84908),i=t(34926);class o extends a.d{constructor(){super(s.default,s.default.user,["email","firstName","lastName","firstNameArabic","lastNameArabic"].map(e=>`${e}`))}async create(e,r=["USER"]){if(await this.prisma.user.findUnique({where:{email:e.email}}))throw Error("User with this email already exists");let t=await i.Ay.hash(e.password,10);return this.prisma.user.create({data:{...e,password:t,roles:{create:r.map(e=>({role:{connectOrCreate:{where:{name:e},create:{name:e}}}}))}},include:{roles:{include:{role:!0}}}})}async findById(e){return this.prisma.user.findUnique({where:{id:e},include:{roles:{include:{role:!0}}}})}async update(e,r,t){r.password&&(r.password=await i.Ay.hash(r.password,10));let a=await this.prisma.user.update({where:{id:e},data:r,include:{roles:{include:{role:!0}}}});return t&&t.length>0?(await this.prisma.userRole.deleteMany({where:{userId:e}}),await Promise.all(t.map(async r=>{let t=await this.prisma.role.findUnique({where:{name:r}});if(t)return this.prisma.userRole.create({data:{userId:e,roleId:t.id}})})),this.prisma.user.findUnique({where:{id:e},include:{roles:{include:{role:!0}}}})):a}async delete(e){return await this.prisma.userRole.deleteMany({where:{userId:e}}),this.prisma.user.delete({where:{id:e}})}}}};