"use strict";exports.id=5220,exports.ids=[5220],exports.modules={65220:(t,e,a)=>{a.d(e,{K:()=>i});var s=a(96330),n=a(22565),d=a(84908);class i extends n.d{constructor(){super(d.default,d.default.post,[])}async create(t){if(!t.translations||0===t.translations.length)throw Error("At least one translation is required");for(let e of t.translations)if(await this.prisma.postTranslation.findUnique({where:{slug:e.slug}}))throw Error(`Slug '${e.slug}' already exists`);let e=await this.prisma.post.create({data:{status:t.status||s.PostStatus.DRAFT,statusReason:t.statusReason,authorId:t.authorId,postAuthorId:t.postAuthorId,categoryId:t.categoryId,featured:t.featured||!1,metaData:t.metaData||{},createdById:t.createdById,updatedById:t.updatedById,editorId:t.editorId,approvedById:t.approvedById,declinedById:t.declinedById,publishedById:t.publishedById,unpublishedById:t.unpublishedById,declineReason:t.declineReason,translations:{create:t.translations},...t.tags&&t.tags.length>0&&{tags:{create:t.tags.map(t=>({tag:{connect:{id:t}}}))}}},include:{translations:!0,category:{include:{translations:!0}},author:!0,postAuthor:!0,editor:!0,approvedBy:!0,declinedBy:!0,publishedBy:!0,unpublishedBy:!0,media:!0,tags:{include:{tag:!0}}}});return e&&await this.prisma.postRevision.create({data:{postId:e.id,title:t.translations[0].title,titleArabic:t.translations.find(t=>"ar"===t.locale)?.title,content:t.translations[0].content,contentArabic:t.translations.find(t=>"ar"===t.locale)?.content,excerpt:t.translations[0].summary,excerptArabic:t.translations.find(t=>"ar"===t.locale)?.summary,status:e.status,changedById:t.createdById||t.authorId,changeNote:t.changeNote||"Initial creation"}}),e}async getAll(t){let{status:e,locale:a,categoryId:s,authorId:n,editorId:d,featured:i,tag:r,search:o,page:l=1,limit:u=10}=t||{},c={deletedAt:null,...e&&(Array.isArray(e)?{status:{in:e}}:{status:e}),...s&&{categoryId:s},...n&&{authorId:n},...d&&{editorId:d},...void 0!==i&&{featured:i},...r&&{tags:{some:{tag:{id:r}}}},...o&&{OR:[{translations:{some:{title:{contains:o,mode:"insensitive"}}}},{translations:{some:{content:{contains:o,mode:"insensitive"}}}},{translations:{some:{summary:{contains:o,mode:"insensitive"}}}}]}},p=await this.prisma.post.count({where:c}),h=Math.ceil(p/u);return{posts:await this.prisma.post.findMany({where:c,skip:(l-1)*u,take:u,orderBy:[{featured:"desc"},{updatedAt:"desc"}],include:{translations:!a||{where:{locale:a}},category:{include:{translations:!a||{where:{locale:a}}}},author:!0,postAuthor:!0,editor:!0,approvedBy:!0,declinedBy:!0,publishedBy:!0,unpublishedBy:!0,media:!0,tags:{include:{tag:!0}},revisionHistory:{orderBy:{createdAt:"desc"},take:1,include:{changedBy:!0}}}}),total:p,pages:h}}async getById(t,e){return this.prisma.post.findUnique({where:{id:t},include:{translations:!e||{where:{locale:e}},category:{include:{translations:!e||{where:{locale:e}}}},author:!0,postAuthor:!0,editor:!0,approvedBy:!0,declinedBy:!0,publishedBy:!0,unpublishedBy:!0,media:!0,tags:{include:{tag:!0}},revisionHistory:{orderBy:{createdAt:"desc"},take:5,include:{changedBy:!0}}}})}async getBySlug(t){let e=await this.prisma.postTranslation.findUnique({where:{slug:t},include:{post:{include:{translations:!0,category:{include:{translations:!0}},author:!0,postAuthor:!0,editor:!0,approvedBy:!0,publishedBy:!0,media:!0,tags:{include:{tag:!0}}}}}});return e?e.post:null}async incrementViewCount(t){await this.prisma.post.update({where:{id:t},data:{viewCount:{increment:1}}})}async update(t,e){let a=await this.prisma.post.findUnique({where:{id:t},include:{translations:!0}});if(!a)throw Error("Post not found");let n={...e};if(e.categoryId&&(n.category={connect:{id:e.categoryId}},delete n.categoryId),e.authorId&&(n.author={connect:{id:e.authorId}},delete n.authorId),e.postAuthorId&&(n.postAuthor={connect:{id:e.postAuthorId}},delete n.postAuthorId),e.editorId&&(n.editor={connect:{id:e.editorId}},delete n.editorId),e.approvedById&&(n.approvedBy={connect:{id:e.approvedById}},delete n.approvedById),e.declinedById&&(n.declinedBy={connect:{id:e.declinedById}},delete n.declinedById),e.publishedById&&(n.publishedBy={connect:{id:e.publishedById}},delete n.publishedById),e.unpublishedById&&(n.unpublishedBy={connect:{id:e.unpublishedById}},delete n.unpublishedById),e.updatedById&&(n.updatedBy={connect:{id:e.updatedById}},delete n.updatedById),e.mediaIds&&Array.isArray(e.mediaIds)&&(n.media={connect:e.mediaIds.map(t=>({id:t}))},delete n.mediaIds),e.status)switch(e.status){case s.PostStatus.PUBLISHED:a.status!==s.PostStatus.PUBLISHED&&(n.publishedAt=new Date);break;case s.PostStatus.UNPUBLISHED:break;case s.PostStatus.ARCHIVED:n.archivedAt=new Date;break;case s.PostStatus.WAITING_APPROVAL:n.declineReason=null;case s.PostStatus.READY_TO_PUBLISH:case s.PostStatus.DECLINED:}e.translations&&e.translations.length>0&&e.updatedById&&!e.editorId&&(n.editor={connect:{id:e.updatedById}}),e.translations&&e.translations.map(e=>{let s=a.translations.find(t=>t.locale===e.locale);return s?{where:{id:s.id},update:e,create:{...e,postId:t}}:{where:{id:"non-existent-id"},update:e,create:{...e,postId:t}}});let d=e.tags?{deleteMany:{},create:e.tags.map(t=>({tag:{connect:{id:t}}}))}:void 0,i=await this.prisma.post.update({where:{id:t},data:{...n,translations:e.translations?{upsert:e.translations.map(t=>{let e=a.translations.find(e=>e.locale===t.locale);return{where:{id:e?.id||"non-existent-id"},update:{locale:t.locale,title:t.title,content:t.content,summary:t.summary,slug:t.slug,dir:t.dir},create:{locale:t.locale,title:t.title,content:t.content,summary:t.summary,slug:t.slug,dir:t.dir}}})}:void 0,tags:d},include:{translations:!0,category:{include:{translations:!0}},author:!0,postAuthor:!0,editor:!0,approvedBy:!0,declinedBy:!0,publishedBy:!0,unpublishedBy:!0,media:!0,tags:{include:{tag:!0}}}});return i&&(e.translations||e.status)&&await this.prisma.postRevision.create({data:{postId:i.id,title:i.translations[0]?.title||"",titleArabic:i.translations.find(t=>"ar"===t.locale)?.title||null,content:i.translations[0]?.content||"",contentArabic:i.translations.find(t=>"ar"===t.locale)?.content||null,excerpt:i.translations[0]?.summary||null,excerptArabic:i.translations.find(t=>"ar"===t.locale)?.summary||null,status:i.status,changedById:e.updatedById||i.authorId,changeNote:e.changeNote||this.getStatusChangeNote(a.status,i.status)}}),i}getStatusChangeNote(t,e){if(t===e)return"Updated content";switch(e){case s.PostStatus.DRAFT:return"Saved as draft";case s.PostStatus.WAITING_APPROVAL:return"Submitted for approval";case s.PostStatus.READY_TO_PUBLISH:return"Approved and ready to publish";case s.PostStatus.PUBLISHED:return"Published";case s.PostStatus.UNPUBLISHED:return"Unpublished";case s.PostStatus.ARCHIVED:return"Archived";case s.PostStatus.DECLINED:return"Declined";default:return"Status changed"}}async softDelete(t){return this.prisma.post.update({where:{id:t},data:{deletedAt:new Date}})}async hardDelete(t){return await this.prisma.postTranslation.deleteMany({where:{postId:t}}),await this.prisma.postTag.deleteMany({where:{postId:t}}),this.prisma.post.delete({where:{id:t}})}async getTags(){return this.prisma.tag.findMany({orderBy:{name:"asc"}})}async createTag(t,e){return this.prisma.tag.create({data:{name:t,nameArabic:e}})}async getAwaitingApproval(t){return this.getAll({status:s.PostStatus.WAITING_APPROVAL,...t})}async getReadyToPublish(t){return this.getAll({status:s.PostStatus.READY_TO_PUBLISH,...t})}async getRevisionHistory(t){return this.prisma.postRevision.findMany({where:{postId:t},orderBy:{createdAt:"desc"},include:{changedBy:!0}})}async changeStatus(t,e,a,n,d){let i=await this.prisma.post.findUnique({where:{id:t},include:{translations:!0}});if(!i)throw Error("Post not found");let r={status:e,updatedById:a,statusReason:n,statusUpdatedAt:new Date};switch(e){case s.PostStatus.PUBLISHED:r.publishedAt=new Date,r.publishedById=a;break;case s.PostStatus.UNPUBLISHED:r.unpublishedById=a;break;case s.PostStatus.READY_TO_PUBLISH:r.approvedById=a;break;case s.PostStatus.DECLINED:r.declinedById=a,r.declineReason=n;break;case s.PostStatus.WAITING_APPROVAL:r.declineReason=null;break;case s.PostStatus.ARCHIVED:r.archivedAt=new Date}let o=await this.prisma.post.update({where:{id:t},data:r,include:{translations:!0,category:{include:{translations:!0}},author:!0,editor:!0,approvedBy:!0,declinedBy:!0,publishedBy:!0,unpublishedBy:!0,media:!0,tags:{include:{tag:!0}}}});return await this.prisma.postRevision.create({data:{postId:o.id,title:o.translations[0]?.title||"",titleArabic:o.translations.find(t=>"ar"===t.locale)?.title||null,excerpt:o.translations[0]?.summary||null,excerptArabic:o.translations.find(t=>"ar"===t.locale)?.summary||null,status:o.status,changedById:a,changeNote:d||this.getStatusChangeNote(i.status,e)}}),o}}}};