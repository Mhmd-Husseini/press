name: Setup SSL Certificate

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Domain name for SSL certificate'
        required: true
        default: 'husseini.click'

jobs:
  setup-ssl:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSL Certificate
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "ğŸ”’ Setting up SSL certificate for ${{ github.event.inputs.domain }}..."
          
          # Update system packages
          echo "ğŸ“¦ Updating system packages..."
          sudo apt update
          
          # Install Certbot and Nginx plugin
          echo "ğŸ”§ Installing Certbot..."
          sudo apt install certbot python3-certbot-nginx -y
          
          # Check if Nginx is running
          echo "ğŸŒ Checking Nginx status..."
          if ! sudo systemctl is-active --quiet nginx; then
              echo "âš ï¸ Nginx is not running. Starting Nginx..."
              sudo systemctl start nginx
              sudo systemctl enable nginx
          fi
          
          # Check if domain resolves
          echo "ğŸ” Checking domain resolution..."
          if ! nslookup ${{ github.event.inputs.domain }} > /dev/null 2>&1; then
              echo "âš ï¸ Warning: ${{ github.event.inputs.domain }} might not be resolving yet."
              echo "   Please wait 5-10 minutes for DNS propagation."
              echo "   You can continue, but certificate might fail."
          fi
          
          # Get SSL certificate
          echo "ğŸ« Obtaining SSL certificate..."
          sudo certbot --nginx -d ${{ github.event.inputs.domain }} -d www.${{ github.event.inputs.domain }} --non-interactive --agree-tos --email admin@${{ github.event.inputs.domain }} --redirect
          
          # Check if certificate was obtained successfully
          if [ $? -eq 0 ]; then
              echo "âœ… SSL certificate obtained successfully!"
              
              # Test auto-renewal
              echo "ğŸ”„ Testing certificate renewal..."
              sudo certbot renew --dry-run
              
              # Set up auto-renewal cron job
              echo "â° Setting up auto-renewal..."
              (crontab -l 2>/dev/null; echo "0 */12 * * * /usr/bin/certbot renew --quiet") | crontab -
              
              # Reload Nginx
              echo "ğŸ”„ Reloading Nginx..."
              sudo systemctl reload nginx
              
              echo "âœ… SSL setup completed successfully!"
              echo "ğŸŒ Your site is now secure at: https://${{ github.event.inputs.domain }}"
              echo "ğŸ”’ Certificate will auto-renew every 90 days"
              
              # Show certificate info
              echo "ğŸ“‹ Certificate information:"
              sudo certbot certificates
              
          else
              echo "âŒ SSL certificate setup failed!"
              echo "ğŸ”§ Troubleshooting steps:"
              echo "   1. Check if domain is pointing to this server"
              echo "   2. Ensure ports 80 and 443 are open"
              echo "   3. Wait for DNS propagation (5-10 minutes)"
              echo "   4. Check Nginx configuration"
              exit 1
          fi

    - name: Notify on Success
      if: success()
      run: |
        echo "ğŸ‰ SSL setup successful!"
        echo "ğŸŒ Your site is now secure at: https://${{ github.event.inputs.domain }}"

    - name: Notify on Failure
      if: failure()
      run: |
        echo "âŒ SSL setup failed!"
        echo "Please check the logs and try again." 