name: Weekly Database Backup

on:
  schedule:
    # Run every 2 weeks on Sunday at 2 AM UTC
    - cron: '0 2 * * 0/2'
  workflow_dispatch: # Allow manual trigger from GitHub UI

jobs:
  backup-database:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: staging # Always checkout staging branch for scheduled backups
        
      - name: Run backup on EC2 server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "🗄️ Starting automated database backup..."
            cd /var/www/phoenix-press
            
            # Download latest backup script from repository
            curl -o scripts/backup-database.sh \
              https://raw.githubusercontent.com/Mhmd-Husseini/press/staging/scripts/backup-database.sh
            
            # Make it executable
            chmod +x scripts/backup-database.sh
            
            # Run the backup script
            ./scripts/backup-database.sh
            
            echo "✅ Database backup completed successfully!"
            echo "📅 Next backup scheduled for 2 weeks from now"
            
      - name: Backup Success Notification
        if: success()
        run: |
          echo "🎉 Database backup completed successfully!"
          echo "🔗 Check S3 bucket: inventory-managment-husseini/database-backups/"
          echo "📅 Next backup: 2 weeks from now"
          
      - name: Backup Failure Notification
        if: failure()
        run: |
          echo "❌ Database backup failed!"
          echo "🔧 Please check:"
          echo "   - EC2 server connectivity"
          echo "   - Database connection in EC2"
          echo "   - S3 permissions for EC2 IAM role"